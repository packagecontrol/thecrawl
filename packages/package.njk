---
layout: layout.njk
permalink: "package/{{ pkg.name | safe }}/"
pagination:
  data: collections.packages
  size: 1
  alias: pkg
eleventyComputed:
  title: "{{ pkg.name }}"
  description: "{{ pkg.description }}"
---

{% import "packages/macros.njk" as pack %}

<h1 class="big">{{ pkg.name }}</h1>
<p class="description">{{ pkg.description }}</p>

<p>
  By
  {% for author in pkg.author -%}
    {% set q = 'author:"' ~ author ~ '"' %}
    <a href="/?q={{ q | urlencode }}">{{ author }}</a>{{ ", " if not loop.last }}
  {%- endfor %}
  {% if pkg.created_at %}
    <br>
    Since {{ pkg.created_at | date_format }}
  {% endif %}
</p>

{{ pack.stars(pkg.stars) }}
{{ pack.labels(pkg.platforms, pkg.labels) }}

{% if pkg.releases | length > 1 %}
  <h2>Versions</h2>
{% else %}
  <h2>Version</h2>
{% endif %}

{% for release in pkg.releases %}
  <p><a class="release" href="{{ release.url }}">{{ release.version }}</a>
  {% if release.sublime_text != "*" %}
    <span class="requirement">({{ release.sublime_text }})</span>
  {% endif %}
  <br>
  {{ release.date }}
  {% if release.platforms | length > 0 %}
    â€” {{ release.platforms | join(', ') }}
  {% endif %}
  </p>
{% endfor %}

<h2>Links</h2>

<ul class="button-group links">
  {% if not "packagecontrol.io" in pkg.homepage | lower and pkg.details != pkg.homepage %}
  <li>
    <a class="button" href="{{ pkg.homepage }}">{{ pack.logo('home') }} <span>Website</span></a>
  </li>
  {% endif %}
  <li>
    <a class="button" href="{{ pkg.details }}">{{ pack.logo('repo') }} <span>Repository</span></a>
  </li>
  <li>
    <a class="button" href="{{ pkg.readme }}">{{ pack.logo('file') }} <span>README</span></a>
  </li>
  {% if pkg.issues %}
    <li>
    <a class="button" href="{{ pkg.issues }}">{{ pack.logo('bug') }} <span>Issues</span></a>
  </li>
  {% endif %}
  {% if pkg.donate %}
    <li>
    <a class="button" href="{{ pkg.donate }}">{{ pack.logo('gift') }} <span>Donate</span></a>
  </li>
  {% endif %}
</ul>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

<div id="md"></div>

<script>
const cacheKey = `md:{{ pkg.readme }}`;
const ttl = 60 * 60; // 1 hour in seconds

const target = document.getElementById('md');
const cached = JSON.parse(sessionStorage.getItem(cacheKey) || "null");
const now = Math.floor(Date.now() / 1000);
if (cached && (now - cached.time) < ttl) {
  target.innerHTML = cached.html;
} else {
  fetch('{{ pkg.readme }}')
    .then(res => res.text())
    .then(md => {
      if (DOMPurify.isSupported) {
          const html = marked.parse(md);
          const safe = DOMPurify.sanitize(html);
          sessionStorage.setItem(cacheKey, JSON.stringify({ html: safe, time: now }));
          target.innerHTML = safe;
        } else {
          const escaped = md
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
          target.innerHTML = escaped;
          target.className = 'raw';        }
    });
}
</script>
